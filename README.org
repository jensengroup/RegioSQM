# last edit:  2020-10-18 (YYYY-MM-DD)
#+OPTIONS: toc:nil

#+LATEX_CLASS:  koma-article
#+LATEX_HEADER: \usepackage{libertine, graphicx, microtype}
#+LATEX_HEADER: \usepackage[scaled=0.75]{beramono}
#+LATEX_HEADER: \usepackage[libertine]{newtxmath}
#+LATEX_HEADER: \usepackage[USenglish]{babel}

* RegioSQM
** Background

   RegioSQM predicts the (hetero)aromatic CH sites most likely
   susceptible to the electrophilic aromatic substitution (EAS).  For
   this, the heat of formation of protonated intermediates is computed
   by MOPAC at the PM3/COSMO level.  When testing this approach for
   535 substrates belonging to 69 groups (e.g., benzenes, pyridines),
   the authors observed 96% of the computed predictions to match the
   experimental evidence.  The authors maintain a dedicated web site,
   [[http://regiosqm.org][regiosqm.org]], to perform these computations for individual
   molecules, expressed by a SMILES string.

   The scripts of this repository offer a local deployment of
   RegioSQM, to perform the batch wise scrutiny of substrates
   expressed as a list of SMILES strings.  Most of the information
   provided here is described in greater detail in the seminal
   [[https://doi.org/10.1039/C7SC04156J][RegioSQM paper]], an open access publication.

** Show case

   For a given substrate, RegioSQM probes any (hetero)aromatic
   position /theoretically susceptible/ for an electrophilic
   substitution reaction (EAS)

   #+ATTR_LATEX:  :width 6cm
   [[./doc_support/scheme_1_050.png]]

   by the addition of hydrogen to yield the charged intermediate.  For
   each position, the heat of formation of this intermediate is
   computed.  As for pyrazole (line a), for example,

   #+ATTR_LATEX:  :width 6cm
   [[./doc_support/figure_1_050.png]]

   protonation in the 4-position yields the least endothermic charged
   regioisomer (169.4 kcal/mol, if computed at the level of
   PM3/COSMO)[fn:COSMO] which RegioSQM indicates by a green dot.  This
   is backed by experimental findings; in the course of an EAS,
   bromine of /N/-bromosuccinimide (NBS) exclusively adds to this
   position.  The illustrations indicate the sites experimentally
   determined as most prominent to the EAS by a black circle.

   For one substrate, RegioSQM compares the heat of formation of
   regioisomers of the putative protonated intermediates of an EAS
   (test site) with the regioisomer yielding the protonated
   intermediate most favorable for the EAS (reference site).  If the
   test site differs by less than 1 kcal/mol (4.18 kJ/mol) from the
   reference site, RegioSQM marks this site equally by a green dot.
   If the test site differs from the reference site by more than
   1 kcal/mol, but less than 3 kcal/mol (12.6 kJ/mol), RegioSQM marks
   this site less susceptible to the EAS by a red dot.  Test sites
   exceeding the 3 kcal/mol threshold are not marked by RegioSQM.  The
   prediction about /N/-methyl imidazole (line b), indeed is backed by
   experimental evidence where the EAS with NBS yields a mixture of
   the two highlighted regioisomers.

   If RegioSQM recognizes a substrate as conformational flexible, by
   default, per site /theoretically susceptible/ to an EAS, the heat
   of formation for 20 conformers of the intermediate are computed.
   It is then the least endothermic charged conformer per site's
   intermediate which eventually is used to rank the sites per input
   molecule.

   As shown, on occasion, the experimentally observed sites of EAS
   (black circle) do not coincide with sites RegioSQM predicts as
   highly susceptible (green dot) or moderately susceptible (red dot)
   to the EAS when comparing all sites of the currently scrutinized
   substrate with each other.  Steric hindrance is one plausible cause
   for such a discrepancy.  This however should be balanced with the
   low computational cost of the method deployed (PM3/COSMO instead of
   DFT) yielding fast access to the results within minutes.  The
   authors claim a rate of success predicting the sites of the EAS
   correctly of up to 92% or 96% (depending on the threshold applied).

   #+ATTR_LATEX:  :width 6cm
   [[./doc_support/figure_4_050.png]]

   In permutation with 69 mono- and bicyclic (hetero)aromatic core
   structures, a large range of substituents was tested.  The SI of
   the publication compiles 535 substrates.

   #+ATTR_LATEX:  :width 12cm
   [[./doc_support/figure_3_050.png]]

** Local set up

   RegioSQM is a set of Python scripts depending on
   + OpenBabel (https://github.com/openbabel/openbabel/releases)
   + RDKit (http://www.rdkit.org/docs/Install.html)
   + numpy
    (https://numpy.org/doc/stable/user/install.html?highlight=installation),
    but often already included in scipy
    (https://scipy.org/install.html)
   + MOPAC (http://openmopac.net/) Note James Stuart updates the
     program multiple times per year ([[http://openmopac.net/Maintenance.html][release table]]).
   Because MOPAC's computations typically are /the/ overall
   rate-determining step in the course of the predictions, it is
   recommended to run multiple concurrently working instances of
   MOPAC.  For running RegioSQM in Linux, GNU Parallel
   (https://www.gnu.org/software/parallel/) was identified as a
   suitable tool one optional script of RegioSQM depends on, in
   addition.

   As an example, Linux Debian 10, branch unstable, resolves the
   dependencies successfully by the instruction of
   #+begin_src shell
     sudo apt-get install python3-openbabel rdkit python3-numpy parallel
   #+end_src
   
   Alternatively, RDKit may be used in an instance of Anaconda
   (https://www.anaconda.com/) which may be installed and used
   side-by-side to other, already existing installations of Python.
   If just venturing out RegioSQM, the smaller installation of
   Miniconda (https://docs.conda.io/en/latest/miniconda.html) suffices
   which -- like the larger Anaconda -- has to be complemented by
   RDKit and OpenBabel by the instruction of
   #+begin_src shell
     conda install -c conda-forge rdkit openbabel
   #+end_src
   The standard installation of Miniconda3 (Python 3.8, Linux 64-bit)
   for example creates =/home/USER/miniconda3= hosting the new
   environment (339 MB prior, 1.1 GB after the additional installation
   of OpenBabel, RDKit and automatically resolved secondary
   dependencies like numpy).  If choosing this option, the optional
   paralleliziation requires separate installation of GNU Parallel.
   To switch-off conda's automatic base activation seen in the
   terminal, issue the command
   #+begin_src shell
     conda config --set auto_activate_base false
   #+end_src
   after which you still may issue on the terminal the instructions
   #+begin_src shell
     conda activate   # start working in the conda profile
     conda deactivate  # end working in the conda profile
   #+end_src
   
   Since RegioSQM release 2.0.0-beta, the scripts are ported to
   Python 3 only.  They were tested in a replication with
   Python 3.8.6rc1 (Sep 14, 2020), OpenBabel 3.1.0 (Jun 9, 2020), and
   RDKit (2019.09.1) in Linux Debian 10 with computations relayed to
   MOPAC2016 (20.173L 64bit, June 2020).

   As legacy, [[https://github.com/nbehrnd/RegioSQM/releases/tag/1.1.1][release 1.1.1]] is the last set of scripts of RegioSQM
   known to work both with Python 2.7.17, and 2.7.18 (Apr 20, 2020)
   respectively.  Keep in mind, however, this requires RDKit [[http://www.rdkit.org/docs/GettingStartedInPython.html][/prior/
   to release 2019.3]].

* Local use
** Preparation

   RegioSQM expects the input as a list of SMILES strings in the same
   folder as its scripts.  If your molecule sketcher of choice does
   not offer the export into this format, consider [[http://openbabel.org/wiki/Main_Page][OpenBabel]] for a
   (batch) conversion of your structure files into this format, or
   copy-paste the strings provided by a service like the [[https://pubchem.ncbi.nlm.nih.gov/edit3/index.html][PubChem
   Sketcher]].

   The call of
   #+BEGIN_SRC shell
     python ../regiosqm/regiosqm.py -g example.smiles > example.csv
   #+END_SRC
   triggers the read-out of the structure data from =example.smiles=
   /to generate/ MOPAC's input files (=.mop=) to probe each site of
   the submitted substrates for an EAS.  For flexible substrates,
   RegioSQM will extend MOPAC's scrutiny automatically to up to
   20 confomers per site probed.  File =example.csv= assists later in
   RegioSQM's bookkeeping.

** MOPAC computation

   It is recommended to parallelize MOPAC's work, often /the/ overall
   rate determining step of the prediction, as much as possible. For
   [[https://www.gnu.org/software/parallel/][GNU Parallel]] in Linux, an instruction in the pattern of
   #+BEGIN_SRC shell
     ls *.mop | parallel -j4 "/opt/mopac/MOPAC2016.exe {}"
   #+END_SRC
   allows up to four concurrent instances (=-j4=) on a computer with
   four processors.  If MOPAC was not installed in the recommended
   default directory (see [[http://www.openmopac.net/Manual/trouble_shooting.html#default%20location][workaround]]), adjust the pathway accordingly.

** Analysis

   By call of
   #+BEGIN_SRC shell
     python regiosqm.py -a example.smiles example.csv > results.txt
   #+END_SRC
   RegioSQM starts to /analyze/ MOPAC's results.  Based on the list of
   substrates (=example.smiles=) and list of regioisomers of the
   putative intermediates (=example.csv=) as the two mandatory
   parameters, the free energies of formation for all sites'
   intermediate (and site's intermediates conformers, where
   applicable) will be read and ranked to yield the summary file
   =results.txt= as space separated table:
   #+BEGIN_SRC shell
     comp1 1 1,3
     comp2 2 2
   #+END_SRC
   After the name of the parental structure provided (=comp1=)
   provided by =example.smiles=, the second column lists the position
   most likely susceptible to the EAS.  Equally, any other site
   leading to an intermediate less than 1 kcal/mol higher than the
   global winning site, will be listed here.  The integer print here
   is RDKit's attributed atom index.  The third column lists all sites
   listed in the second column and adds those yielding a protonated
   intermediate (conformer) less than 3 kcal/mol apart from the global
   winning site in the currently scrutinized molecule.

   In the background, RDKit illustrates MOPAC's results by writing for
   each molecule SMILES string its corresponding =.svg= where the most
   favorable sites for the EAS (entries of the second column) are
   marked by green dot, and those /only/ mentioned in the third column
   by a red dot.

  #+LATEX: \vspace{0.5cm} 
  Hint: The optional script =batch_regiosqm.py= automates the serial
  scrutiny of SMILES list files (the preparation of MOPAC input files,
  the parallel work of MOPAC with four CPUs, analysis of the results,
  collection and eventually zip-archiving input and output files per
  SMILES list to be scrutinized).  Assuming the optional installation
  of GNU Parallel and four CPU, it suffices to drop such list of
  SMILES formatted like file =quick_smiles.csv= from sub-folder
  =quick= into the same folder as all RegioSQM scripts and to issue
  the instruction
  #+begin_src shell
    python3 batch_regiosqm.py
  #+end_src

* validation of a local installation

** Quick check

   Sub-folder =quick= contains a input, intermediate and output for a
   set of 36 substrates from different EAS classes to check a local
   installation quickly.  Preference was given to molecules with a
   conformational rigid core to prevent RegioSQM investing much time
   scrutinizing many conformers of charged intermediates.

** Extensive check

   Further development of MOPAC and RegioSQM may affect the sites in a
   molecule predicted to be more likely susceptible to the EAS, than
   others.  To identify changes since submission of the seminal
   publication in 2017, the scrutiny of substrates tested was
   replicated.  Tools used and intermediate results obtained (e.g.,
   SMILES strings / illustrated atom indices per EAS class) as obtained
   with release 2.0.0-beta are provided in folder =replication=.
   Especially the results in sub-folder =predicted_sites= allow now a
   quick comparison of a current and of future local installations of
   RegioSQM a rapid diffview of texts.

   In comparison of the results depicted in the SI of the seminal
   paper, only 47 out of 535 pattern (8.8%) reexamined changed since
   them.  Among these, changes for the definitively better (22 pattern,
   about 4.1%) or definitively worse (22) are scattered over multiple
   EAS classes.  For 2 pattern (about 0.4%), no attribution for the
   better or worse was made.


* Footnotes

[fn:COSMO] The implementation of COSMO, the «COnductor-like Screening
MOdel» in MOPAC is described in its [[http://openmopac.net/manual/cosmo.html][manual]].  By default, computations
by RegioSQM are performed with MOPAC's implicit effective van der
Waals radius of the solvent of 1.3 \AA and an explicitly defined
dielectric constant of 4.8 (chloroform, script =molecule_formats.py=).
